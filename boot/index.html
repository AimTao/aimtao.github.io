<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="76x76" href="https://hutu0.aimtao.net/site/icon.webp"><link rel="icon" href="https://hutu0.aimtao.net/site/icon.webp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="AimTao"><meta name="keywords" content="C++,Python,Go,算法，开发,blog,后端,记录"><meta name="description" content="电脑按下开机键发生了什么？"><title>Linux 内核｜启动 - AimTao</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2113603_2ltiep6fmf8.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/lxgwwenkai-regular.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.aimtao.net",root:"/",version:"1.9.1",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"sh"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h2,h3,h4",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:"07fe5d228ae82eadee00480515f9d64b",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hkFccy0TBvlTMrTD2n9MwSIx-gzGzoHsz",app_key:"yUJSgy6kcnRscdGX9ec7jlFz",server_url:"https://analytics.aimtao.net",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><style type="text/css">.spoiler{display:inline}p.spoiler{display:flex}.spoiler a{pointer-events:none}.spoiler-blur,.spoiler-blur>*{transition:text-shadow .5s ease}.spoiler .spoiler-blur,.spoiler .spoiler-blur>*{color:transparent;background-color:rgba(0,0,0,0);text-shadow:0 0 10px grey;cursor:pointer}.spoiler .spoiler-blur:hover,.spoiler .spoiler-blur:hover>*{text-shadow:0 0 5px grey}.spoiler-box,.spoiler-box>*{transition:color .5s ease,background-color .5s ease}.spoiler .spoiler-box,.spoiler .spoiler-box>*{color:#000;background-color:#000;text-shadow:none}</style><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="AimTao" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>AimTao&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> Home</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> Categories</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> Tags</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> About</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> Links</a></li><li class="nav-item"><a class="nav-link" href="/atom.xml"><i class="iconfont icon-rss"></i> RSS</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-archive-fill"></i> Archives</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/">Timeline </a><a class="dropdown-item" href="/categories/Implement-From-Scratch/">Implement From Scratch </a><a class="dropdown-item" href="/tags/Kernel/">Linux kernel </a><a class="dropdown-item" href="/categories/Mark/">Mark</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://hutu.aimtao.net/web/2021-08-11-interrupt.webp-s) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Linux 内核｜启动"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-09-06 10:00" pubdate>2021-09-06 AM</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 8.2k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 7 mins</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Kernel" id="heading-6ff9f4444ac481652f4412b5e1623846" role="tab" data-toggle="collapse" href="#collapse-6ff9f4444ac481652f4412b5e1623846" aria-expanded="true">Kernel <span class="list-group-count">(5)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-6ff9f4444ac481652f4412b5e1623846" role="tabpanel" aria-labelledby="heading-6ff9f4444ac481652f4412b5e1623846"><div class="category-post-list"><a href="/memory-management/" title="Linux 内核｜内存管理" class="list-group-item list-group-item-action"><span class="category-post">Linux 内核｜内存管理</span> </a><a href="/system-call/" title="Linux 内核｜系统调用" class="list-group-item list-group-item-action"><span class="category-post">Linux 内核｜系统调用</span> </a><a href="/init/" title="Linux 内核｜初始化" class="list-group-item list-group-item-action"><span class="category-post">Linux 内核｜初始化</span> </a><a href="/boot/" title="Linux 内核｜启动" class="list-group-item list-group-item-action active"><span class="category-post">Linux 内核｜启动</span> </a><a href="/interrupt/" title="Linux 内核｜中断" class="list-group-item list-group-item-action"><span class="category-post">Linux 内核｜中断</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Linux 内核｜启动</h1><p class="note note-info">本文最后更新于：4 years ago</p><div class="markdown-body"><h2 id="1-计算机工作模式">1.计算机工作模式</h2><h3 id="1-1-CPU-三大构成">1.1 CPU 三大构成</h3><ul><li><p>运算单元：做加法、做位移等等。不知道算哪些数据、结果存哪里。</p></li><li><p>数据单元：包括CPU内部缓存 + 寄存器组，暂时存放数据 + 运算结果。</p></li><li><p>控制单元：获取指令、执行指令。这个指令会指导运算单元从数据单元取某个数，并执行某个运算，最后存入数据单元的某个地方</p></li></ul><p><img src="https://hutu.aimtao.net/mark/2021-09-19-ioOqZW.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><h3 id="1-2-控制单元工作原理">1.2 控制单元工作原理</h3><p>CPU 在执行程序时，控制单元完成其工作？（知道取哪些数、执行哪个运算、存到哪里）</p><ul><li><p><strong>指令指针寄存器</strong>：存有下一条指令在内存中的地址。</p></li><li><p><strong>指令寄存器</strong>：控制单元会按照 <strong>指令指针寄存器</strong> 中的地址，从内存中取出指令，存入 <strong>指令寄存器</strong>。</p></li></ul><p>PS：<strong>指令</strong>分为两个部分：<strong>操作码</strong>（运算类型） + <strong>操作数</strong>（运算数据的地址或运算数据本身），操作码交给运算单元，告诉运算单元做什么运算，操作数交给数据单元，让数据单元去读取运算数据。</p><h3 id="1-3-进程切换">1.3 进程切换</h3><p>CPU 中有两个寄存器 CS、DS，分别保存<strong>当前进程</strong>代码段的起始位置、数据段的起始位置。</p><p>例：当进程 A 切换成进程 B 时，CS、DS 便会分别储存进程 B 的代码段起始位置、数据段起始位置。</p><h3 id="1-4-地址总线和数据总线">1.4 地址总线和数据总线</h3><p>CPU 和内存使用总线（Bus）来传输数据。</p><ul><li><p><strong>地址总线（Address Bus）</strong>：传输的是地址数据。</p></li><li><p><strong>数据总线（Data Bus）</strong>：传输的是真正的操作数据。</p></li></ul><p><strong>位数</strong>：</p><ul><li><p><strong>地址总线的位数</strong>：决定了能访问的地址范围到底有多广。例如只有两位，那 CPU 就只能认 00，01，10，11 四个位置，超过四个位置，就区分不出来了。位数越多，能够访问的位置就越多，能管理的内存的范围也就越广。</p><ul><li>32 位系统表示，地址总线为 32 位，地址范围为 232，约 4G 大小。32 位系统最多使用 4G 的内存。</li><li>64 位系统表示，地址总线为 64 位，地址范围为 264，约 16EB 大小。</li></ul></li><li><p><strong>数据总线的位数</strong> = <strong>CPU位宽</strong> = <strong>CPU 内部通用寄存器的位宽</strong>：决定了一次能拿多少个数据进来。例如只有两位，那 CPU 一次只能从内存拿两位数。要想拿八位的 int，就要拿四次。位数越多，一次拿的数据就越多，访问速度也就越快。</p></li></ul><p><strong>补充</strong>：</p><p>除了地址总线和数据总线，还有片内总线、控制总线、通信总线。</p><ul><li><p>片内总线：CPU 芯片内部寄存器与寄存器之间、寄存器与运算单元之间的公共连接线。</p></li><li><p>控制总线：传输控制信息，包括 CPU 发送出去的控制命令、主存（或外设）返回 CPU 的反馈信号。</p></li><li><p>通信总线（外部总线）：不同设备之间信息传输的总线。</p></li></ul><h3 id="1-5-8086-处理器">1.5 8086 处理器</h3><p>8086 处理器如下图：</p><p><img src="https://hutu.aimtao.net/mark/2021-09-19-ZLm3EZ.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><h4 id="1-5-1-数据单元">1.5.1 数据单元</h4><p>由 8 个 16 位的通用寄存器（AX、BX、CX、DX、SP、BP、SI、DI）组成。</p><ul><li><p><strong>AX，BX，CX，DX 作为数据寄存器</strong>：</p><ul><li>AX (Accumulator)：累加寄存器，也称之为累加器</li><li>BX (Base)：基地址寄存器</li><li>CX (Count)：计数器寄存器</li><li>DX (Data)：数据寄存器</li></ul><p>AX、BX、CX、DX 可以分为两个 8 位的寄存器来使用。比如 AX 可以分为 AH、AL 两个寄存器，H 表示 High 高位，L 表示 Low 低位。（优点：既可以储存长数据，也可以储存短数据。也是为了兼容以前基于 8080 等 8 位微处理器的程序。）</p></li><li><p><strong>SP 和 BP 作为指针寄存器</strong>：</p><ul><li>SP (Stack Pointer)：堆栈指针寄存器</li><li>BP (Base Pointer)：基指针寄存器</li></ul></li><li><p><strong>SI 和 DI 作为变址寄存器</strong>：</p><ul><li>SI (Source Index)：源变址寄存器</li><li>DI (Destination Index)：目的变址寄存器</li></ul></li></ul><h4 id="1-5-2-控制单元">1.5.2 控制单元</h4><p>由 2 个控制寄存器（IP、FLAG）和 4 个段寄存器（CS、DS、SS、ES）组成。</p><ul><li><p><strong>控制寄存器</strong>：</p><ul><li>IP (Instruction Pointer)：指令指针寄存器，IP 寄存器存储代码段中下一个指令的地址（实际上是地址偏移量 Offset）。CPU 不断通过 IP 寄存器，将指令从内存的代码段中，加载到 CPU 指令队列缓存器中，然后通过运算单元执行。</li><li>FLAG：标志寄存器</li></ul></li><li><p><strong>段寄存器</strong>：</p><ul><li>CS (Code Segment)：代码段寄存器，代码段在内存中的起始地址。</li><li>DS (Data Segment)：数据段寄存器，数据段在内存中的起始地址。</li><li>SS (Stack Segment)：堆栈段寄存器，实现函数调用时的压栈入栈。</li><li>ES (Extra Segment)：附加段寄存器。</li></ul></li></ul><h4 id="1-5-3-问题">1.5.3 问题</h4><ul><li><p><strong>Q：如何加载内存的数据？</strong></p><p><strong>A</strong>：真实地址 = 16 位的基地址 + 16 位的偏移地址。对于一个段，有一个起始的地址（基地址），而段内的具体位置，我们称为偏移量（Offset）。在 CS 和 DS 中都存放着一个段的起始地址。代码段的偏移量在 IP 寄存器中，数据段的偏移量会放在通用寄存器中。</p></li><li><p><strong>Q：CS、DS 均为 16 位寄存器，能储存的最大地址为 216，地址总线为 20 位，寻址能力为 220，如何提高存储的最大地址？</strong></p><p><strong>A</strong>：原本是16 位的基地址 + 16 位的偏移地址，现在将 CS 和 DS 的值左移 4 位，即<strong>16 位基地址 × 24 + 16位偏移量</strong>。即可满足220的寻址需求。</p></li></ul><p><img src="https://hutu.aimtao.net/mark/2021-09-19-IhmoAr.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><ul><li><p><strong>Q：一个数据段多大？</strong></p><p><strong>A</strong>：偏移量是 16 位，所以一个段最大的大小是 216 = 64KB。</p></li></ul><h3 id="1-6-x86-架构">1.6 x86 架构</h3><p>1985年，intel 推出 80386 处理器，32位处理器，如何继续使用 x86 架构呢？</p><p>为了保证向后兼容（backward），intel 在原来的 x86 架构进行扩展，如下图。</p><p><img src="https://hutu.aimtao.net/mark/2021-09-19-mAdD20.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><ul><li>通用寄存器从 8 个 16 位扩展为 8 个 32 位，同时依然保持了 16 位和 8 位的使用方式。</li><li>IP 寄存器扩展成 32 位，同时兼容 16 位。</li><li>段寄存器依然保持 16 位，但不再是段的起始地址。<ul><li>段的起始地址放在内存中的<strong>段描述符表</strong>，表中含有多个<strong>段描述符</strong>（Segment Descriptor），分别对应着不同的段起始地址。</li><li>段寄存器中存储的则是表格中的索引，称为<strong>选择子</strong>（Selector）。</li><li>段寄存器将 段起始地址 从内存中拿到CPU的段描述符缓存器中，以便 CPU 更快的取到段起始地址。</li></ul></li></ul><p><strong>Q：为什么段寄存器不扩展成 32 位，以便向后兼容？</strong></p><p><strong>A</strong>：232 已经有 4G 大小的寻址能力，是否还需要保留左移 4 位操作，所以不如重新设计。</p><p>但是这样更改，<strong>段寄存器如何向后兼容呢？</strong></p><ul><li><p><strong>实模式</strong>（Real Pattern）：段寄存器储存段起始地址。</p></li><li><p><strong>保护模式</strong>（Protected Pattern）：段寄存器储存段描述表的选择子。</p></li></ul><p>当系统刚启动时，CPU 处于实模式，可以向后兼容。当需要更多的内存时（超过 220 的寻址能力，1M），可以切换到保护模式。</p><h3 id="1-7-实模式与保护模式">1.7 实模式与保护模式</h3><ul><li><p>实模式（Real Mode）：又名 Real Address Mode，地址访问的是真实地内存地址所在位置。在此模式下，可以使用 20位（1MB）的地址空间，软件可以不受限制的操作所有地址的空间和IO设备。</p></li><li><p>保护模式（Protected Mode）：又名 Protected Virtual Address Mode，采用虚拟内存、页等机制对内存进行了保护，比起实模式更为安全可靠，同时也增加了灵活性和扩展性。</p></li></ul><h2 id="2-启动流程">2.启动流程</h2><h3 id="2-1-初始化-BIOS">2.1 初始化 BIOS</h3><p>开机后，按特定的组合键就能进入 BIOS 界面了。</p><p>在主板上，有个 ROM（Read Only Memory，只读存储器），ROM 是只读的，上面固化了初始化程序 BIOS（Basic Input and Output System，基本输入输出系统）。</p><ol><li><p><strong>启动电源</strong></p><p>当按下电源键，主板会发向电源组发出信号，接收到信号后，电源会提供合适的电压给计算机。</p></li><li><p><strong>重置寄存器</strong></p><p>当主板收到电源正常启动的信号后，主板会启动CPU，CPU重置所有寄存器数据，并设置初始化数据，将 CS 设置为 0xFFFF，将 IP 设置为 0x0000。</p></li><li><p><strong>初始化 BIOS</strong></p><p>根据 CS 和 IP 寄存器，计算出的第一个指令地址为 0xFFFF0，这条 JMP 指令会跳到 ROM 中做初始化工作的代码，开始 BIOS 的初始化工作。</p></li></ol><p><strong>Q：为什么要将 CS 设置为 0xFFFF，将 IP 设置为 0x0000？</strong></p><p><strong>A</strong>：这是初始化 BIOS 的指令地址。</p><ul><li><p>实模式启动最多可使用 0 - 0xFFFFF 的 1M 内存空间，由于只有16位寄存器，最大地址只能表示为 0xFFFFF（64KB)，因此不得不采取将内存按段划分为 64KB 的方式来充分利用 1M 内存。</p></li><li><p>在主板上，有个只读的 ROM ，上面固化了初始化程序 BIOS。将 1M 空间最上面的 0xF0000 到 0xFFFFF 这 64K 映射给 ROM。</p></li><li><p>根据 CS 和 IP 寄存器的值计算出的地址便在 ROM 区中（0xFFFF × 16 + 0x0000 = 0xFFFF0）。</p></li></ul><p><img src="https://hutu.aimtao.net/mark/2021-12-13-rP98n7.jpg-s" srcset="/img/loading.gif" lazyload alt="2021-12-13-rP98n7"></p><h3 id="2-2-构建中断向量表">2.2 构建中断向量表</h3><p><img src="https://hutu.aimtao.net/mark/2021-09-19-Jst3y4.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><p>如上图，1M 的具体分区可以分为，</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">0x00000000 - 0x000003FF - Real Mode Interrupt Vector Table    <span class="hljs-comment"># 中断向量表</span><br> 0x00000400 - 0x000004FF - BIOS Data Area   <span class="hljs-comment"># BIOS  数据区</span><br> 0x00000500 - 0x00007BFF - Unused<br> 0x00007C00 - 0x00007DFF - Our Bootloader<br> 0x00007E00 - 0x0009FFFF - Unused<br> 0x000A0000 - 0x000BFFFF - Video RAM (VRAM) Memory<br> 0x000B0000 - 0x000B7777 - Monochrome Video Memory<br> 0x000B8000 - 0x000BFFFF - Color Video Memory<br> 0x000C0000 - 0x000C7FFF - Video ROM BIOS<br> 0x000C8000 - 0x000EFFFF - BIOS Shadow Area<br> 0x000F0000 - 0x000FFFFF - System BIOS<br></code></pre></td></tr></table></figure><ul><li>BIOS 程序在内存最开始的位置（0x00000）用1KB 的内存空间（0x00000～0x003FF）构建<strong>中断向量表</strong>。</li><li>在此位置之后，用 256 字节的内存空间构建 BIOS 数据区（0x00400～0x004FF）。</li><li>并在大约 57KB 以后的位置（0x0E05B）加载了8KB 左右的与中断向量表相应的若干中断服务程序。</li><li>中断向量表中有 256 个中断向量，每个中断向量占 4 字节，其中两个字节是 CS 的值，两个字节是 IP 的值。每个中断向量都指向一个具体的中断服务程序。</li></ul><h3 id="2-3-加载-BootLoader">2.3 加载 BootLoader</h3><blockquote><p>要想启动操作系统，BIOS 需要找到引导盘的第一个扇区——主引导扇区 MBR ，并执行 MBR 的一段代码 BootLoader（引导程序）。</p></blockquote><h4 id="2-3-1-主引导扇区">2.3.1 主引导扇区</h4><ul><li>引导盘（Bootable Disk）第一个扇区是主引导扇区（MBR，Master Boot Record），占 512 个字节，通常是在 /dev/sda 或者 /dev/hda。</li><li>由 446 字节的 MBR引导代码、64 字节的分区表和 2 字节的结束标志组成。最后两个字节为 0x55、0xAA（小端方式存储，实际值为 0xAA55）。</li><li>主引导扇区中最后两个字节，是检验主引导记录是否有效的标志。</li></ul><h4 id="2-3-2-BootLoader-的工作">2.3.2 BootLoader 的工作</h4><p>boot.img 就是 Linux 的 BootLoader 引导程序，位于 MBR 中；由 boot.img 来加载其他 img 文件。</p><ol><li><p><strong>加载 boot.img</strong></p><ul><li>boot.img 由 boot.S 编译而成，512字节，在 MBR 中。</li><li>BIOS 将 boot.img 从 MRB 中加载到内存的 0x7c00 的位置，并执行 boot.img 的代码。至此，BIOS 将控制权交给 boot.img</li></ul></li><li><p>加载 core.img</p><ul><li>core.img 由 lzma_decompress.img、diskboot.img、kernel.img 和一系列的模块组成。</li></ul><p><img src="https://hutu.aimtao.net/mark/2021-09-19-x8ZTSu.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><ul><li><p>boot.img 先加载 core.img 的第一个扇区，即 diskboot.img，对应代码为 diskboot.S。至此，boot.img 将控制权交给 diskboot.img 。</p></li><li><p>diskboot.img 的任务就是将 core.img 的其他部分加载进来。</p><ul><li>diskboot.img 先加载 lzma_decompress.img，它是解压缩程序，用于解压缩 kernel.img，应的代码是 startup_raw.S。</li></ul><blockquote><p>因为实模式 1M 的地址空间太小，在解压缩 kernel.img 之前，<strong>需要将实模式切换成保护模式</strong>（下文具体描述如何切换）。</p></blockquote><ul><li>切换成保护模式后，对压缩过的 kernel.img 进行解压缩，对应的代码是 startup.S 以及一堆 c 文件。（kernel.img 不是 Linux 的内核，而是 grub 的内核。）</li><li>最后加载各个模块 module 对应的映像。</li></ul></li></ul></li><li><p><strong>启动 grub_main 函数</strong></p><ul><li>在 startup.S 中会调用 grub_main，这是 grub kernel 的主函数。</li><li>grub_main 函数初始化控制台，计算模块基地址，设置 root 设备。</li><li>grub_main 函数调用 <code>grub_load_config()</code> 函数，对 grub.conf 文件里的配置信息进行解析。</li><li>如果是正常启动，grub_main 函数调用 <code>grub_command_execute (“normal”, 0, 0)</code> 将 GRUB 置于 normal 模式。</li><li>在 normal 模式中， <code>grub-core/normal/main.c</code> 中的 <code>grub_normal_execute</code> 函数将被调用，以完成最后的准备工作，并调用 <code>grub_show_menu()</code> 显示一个菜单列出所用可用的操作系统。</li></ul><p><img src="https://hutu.aimtao.net/mark/2021-09-19-qWhuay.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><ul><li>当某个操作系统被选择之后，``grub_menu_execute_entry<code>开始执行</code>grub_command_execute (“boot”, 0, 0)`，它将调用 GRUB 的 boot 命令，来引导被选中的操作系统。</li></ul></li></ol><p>至此，系统终于启动了。</p><h2 id="3-切换保护模式">3.切换保护模式</h2><blockquote><p>lzma_decompress.img 调用 <code>real_to_prot</code> 函数，从实模式切换到保护模式。</p></blockquote><p><strong>两大主要事件</strong>：</p><ul><li><strong>启用分段</strong>：在内存里面建立段描述符表，将寄存器里面的段寄存器变成段选择子，指向某个段描述符，这样就能实现不同进程的切换了。</li><li><strong>启动分页</strong>：将内存分成相等大小的块，详见内存管理部分。</li></ul><h3 id="3-1-新旧中断的交替">3.1 新旧中断的交替</h3><ol><li><strong>屏蔽中断</strong><ul><li>在 16 位实模式下的中断由 BIOS 处理，进入保护模式后，中断将交给中断描述符表 IDT 里规定的函数处理。</li><li>在刚进入保护模式时，中断描述符表寄存器（IDTR）的初始值为 0，一旦发生中断（例如BIOS的时钟中断）就将导致CPU发生异常，所以需要首先屏蔽中断。</li><li>屏蔽中断可以使用 cli 指令。</li></ul></li></ol><blockquote><p>全局描述符表寄存器 GDTR、中断描述符表寄存器 IDTR、局部描述符表寄存器 LDTR、任务寄存器 TR。</p></blockquote><ol start="2"><li><strong>初始化全局描述符表 GDT</strong></li></ol><blockquote><ul><li><p>GDT（Global Descriptor Table，全局描述符表），在系统中唯一的存放段寄存器内容（段描述符）的数组，配合程序进行保护模式下的段寻址。它在操作系统的进程切换中具有重要意义，可理解为所有进程的总目录表，其中存放每一个任务（task）局部描述符表（LDT, Local Descriptor Table）地址和任务状态段（TSS, Task Structure Segment）地址，完成进程中各段的寻址、现场保护与现场恢复。GDTR 是 GDT 基地址寄存器，当程序通过段寄存器引用一个段描述符时，需要取得 GDT 的入口，GDTR 标识的即为此入口。在操作系统对 GDT 的初始化完成后，可以用 LGDT（Load GDT）指令将 GDT 基地址加载至 GDTR。</p></li><li><p>IDT（Interrupt Descriptor Table，中断描述符表），保存保护模式下所有中断服务程序的入口地址，类似于实模式下的中断向量表。IDTR（IDT 基地址寄存器），保存 IDT 的起始地址。</p></li></ul></blockquote><p><strong>Q：为什么要建立全局描述符表 GDT？</strong></p><p><strong>A</strong>：16 位空间无法存储 64 位的段描述符。</p><ul><li>在保护模式中，段与段之间是互相隔离的，当访问的地址超出段的界限时处理器就会阻止这种访问。</li><li>因此每个段都需要有<strong>起始地址、范围、访问权限以及其他属性</strong>四个部分，这四个部分合在一起叫做段描述符（Segment Descriptor），总共需要 8 个字节来描述。</li><li>但 Intel 为了保持向后兼容，将段寄存器仍然规定为16 位，我们无法用16 位的段寄存器来直接存储 64 位的段描述符。</li><li>解决的办法是将所有 64 位的段描述符放到一个数组中，将 16 位段寄存器的值作为下标来访问这个数组（以字节为单位），获取 64位 的段描述符，这个数组就叫做全局描述符表（Global Descriptor Table, GDT）。</li></ul><h3 id="3-2-启用-Gate-A20">3.2 启用 Gate A20</h3><blockquote><p>16 位实模式，20 根总线最多访问 1M 的内存空间，现在切换 32 位保护模式，需要开启第 21 根地址线的控制线。</p></blockquote><p>lzma_decompress.img 调用 <code>real_to_prot()</code> 函数启动。打开A20，意味着CPU可以进行 32 位寻址，最大寻址空间为 4 GB。</p><ul><li>实模式下，当程序寻址超过 0xFFFFF 时，CPU将“回滚”至内存地址起始处寻址（注意，在只有20根地址线的条</li></ul><p>件下，0xFFFFF+1=0x00000，最高位溢出）</p><ul><li>此处对A20地址线的启用相当于关闭CPU在实模式下寻址的“回滚”机制。</li></ul><h2 id="4-GRUB2">4.GRUB2</h2><blockquote><p>Grub2（Grand Unified Bootloader Version 2）</p></blockquote><blockquote><p>澄清：</p><ul><li>boot.img、core.img 等 img 文件，属于 Grub2 这个工具的，</li><li>grub2 将 boot.img 转换后的内容安装到 MBR 中，将 core.img 等文件安装在硬盘的其他指定位置。</li></ul></blockquote><p>Linux 内核通过 <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/v4.16/Documentation/x86/boot.txt">Boot Protocol</a> 定义如何实现 BootLoader ，有如 Grub2 和 syslinux 等具体实现方式。</p><ul><li><strong>作用</strong>：Grub2 将 boot.img 安装在 MRB 中，作为 BootLoader（引导程序）。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">grub2-install /dev/sda  <span class="hljs-comment"># /dev/sda 为引导盘。</span><br></code></pre></td></tr></table></figure><ul><li>查看系统启动的配置信息：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">Shell   grub2-mkconfig -o /boot/grub2/grub.cfg     <br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">menuentry <span class="hljs-string">&#x27;CentOS Linux (3.10.0-862.el7.x86_64) 7 (Core)&#x27;</span> --class centos --class gnu-linux --class gnu --class os --unrestricted <span class="hljs-variable">$menuentry_id_option</span> <span class="hljs-string">&#x27;gnulinux-3.10.0-862.el7.x86_64-advanced-b1aceb95-6b9e-464a-a589-bed66220ebee&#x27;</span> &#123;<br>        load_video<br>        <span class="hljs-built_in">set</span> gfxpayload=keep<br>        insmod gzio<br>        insmod part_msdos<br>        insmod ext2<br>        <span class="hljs-built_in">set</span> root=<span class="hljs-string">&#x27;hd0,msdos1&#x27;</span><br>        <span class="hljs-keyword">if</span> [ x<span class="hljs-variable">$feature_platform_search_hint</span> = xy ]; <span class="hljs-keyword">then</span><br>          search --no-floppy --fs-uuid --<span class="hljs-built_in">set</span>=root --hint=<span class="hljs-string">&#x27;hd0,msdos1&#x27;</span>  b1aceb95-6b9e-464a-a589-bed66220ebee<br>        <span class="hljs-keyword">else</span><br>          search --no-floppy --fs-uuid --<span class="hljs-built_in">set</span>=root b1aceb95-6b9e-464a-a589-bed66220ebee<br>        <span class="hljs-keyword">fi</span><br>        linux16 /boot/vmlinuz-3.10.0-862.el7.x86_64 root=UUID=b1aceb95-6b9e-464a-a589-bed66220ebee ro console=tty0 console=ttyS0,115200 crashkernel=auto net.ifnames=0 biosdevname=0 rhgb quiet <br>        initrd16 /boot/initramfs-3.10.0-862.el7.x86_64.img<br>&#125;<br><br></code></pre></td></tr></table></figure><p>以上配置在系统启动时，形成一个列表，选择从哪个系统启动。显示效果如下图。</p><p><img src="https://hutu.aimtao.net/mark/2021-09-19-qWhuay.webp-s" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="参考">参考</h2><ul><li><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html">https://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html</a></li><li><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2013/02/booting.html">https://www.ruanyifeng.com/blog/2013/02/booting.html</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/boyxiao/archive/2010/11/20/1882716.html">https://www.cnblogs.com/boyxiao/archive/2010/11/20/1882716.html</a></li><li><a target="_blank" rel="noopener" href="https://ty-chen.github.io/linux-kernel-bootstrap/">https://ty-chen.github.io/linux-kernel-bootstrap/</a></li><li><a target="_blank" rel="noopener" href="http://home.ustc.edu.cn/~boj/courses/linux_kernel/1_boot.html">http://home.ustc.edu.cn/~boj/courses/linux_kernel/1_boot.html</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/7094693.html#auto_id_0">https://www.cnblogs.com/f-ck-need-u/p/7094693.html#auto_id_0</a></li><li>趣谈 Linux 操作系统</li></ul><script type="text/javascript">!function(l){[].forEach.call(l.getElementsByClassName("fold"),(function(l){l.getElementsByClassName("fold-title")[0].onclick=function(){l.classList.toggle("collapsed"),l.classList.toggle("expanded")}}))}(document)</script></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Kernel/" class="category-chain-item">Kernel</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Linux/">#Linux</a> <a href="/tags/Kernel/">#Kernel</a></div></div><div class="license-box my-3"><div class="license-title"><div>Linux 内核｜启动</div><div>https://www.aimtao.net/boot/</div></div><div class="license-meta"><div class="license-meta-item license-meta-date"><div>Posted on</div><div>2021-09-06</div></div><div class="license-meta-item"><div>Licensed under</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - Share-alike"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/mass-energy-equation/" title="质能方程推导的一点点想法"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">质能方程推导的一点点想法</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/repo/" title="学习笔记｜repo"><span class="hidden-mobile">学习笔记｜repo</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="valine"></div><style>.v[data-class=v] .veditor{background-image:url(https://hutu0.aimtao.net/foot/drinkwater.webp);background-size:contain;background-repeat:no-repeat;background-position:right;resize:none}</style><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.staticfile.org/valine/1.4.18/Valine.min.js",(function(){var e=Object.assign({appId:"Lwz6D7d9XSdSYpjixPxukzhF-gzGzoHsz",appKey:"UhkN5uCsv1zxjYO6nJ7vOjpB",path:"window.location.pathname",placeholder:"本站支持评论邮件提醒功能，在上方输入邮箱，即可收到回复通知！（支持 markdown 语法）",avatar:"robohash",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://valine.aimtao.net",emojiCDN:"https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/",emojiMaps:{666:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6c/2022_666_org.png","微笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e3/2018new_weixioa02_org.png","可爱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/09/2018new_keai_org.png","太开心":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/2018new_taikaixin_org.png","鼓掌":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/2018new_guzhang_org.png","嘻嘻":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/33/2018new_xixi_org.png","哈哈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/2018new_haha_org.png","笑cry":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/2018new_xiaoku_thumb.png","挤眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/43/2018new_jiyan_org.png","馋嘴":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fa/2018new_chanzui_org.png","黑线":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a3/2018new_heixian_org.png","汗":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/28/2018new_han_org.png","挖鼻":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9a/2018new_wabi_thumb.png","哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/2018new_heng_org.png","怒":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/f6/2018new_nu_org.png","委屈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/2018new_weiqu_org.png","可怜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/2018new_kelian_org.png","失望":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/2018new_shiwang_org.png","悲伤":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ee/2018new_beishang_org.png","泪":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/2018new_leimu_org.png","允悲":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/83/2018new_kuxiao_org.png","苦涩":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7e/2021_bitter_org.png","害羞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c1/2018new_haixiu_org.png","污":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/10/2018new_wu_org.png","爱你":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/f6/2018new_aini_org.png","亲亲":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2c/2018new_qinqin_org.png","抱一抱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/2020_hug_org.png","色":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/2018new_huaxin_org.png","憧憬":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c9/2018new_chongjing_org.png","舔屏":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3e/2018new_tianping_org.png","哇":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3d/2022_wow_org.png","坏笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4d/2018new_huaixiao_org.png","阴险":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/2018new_yinxian_org.png","笑而不语":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2d/2018new_xiaoerbuyu_org.png","偷笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/2018new_touxiao_org.png","酷":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c4/2018new_ku_org.png","并不简单":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/2018new_bingbujiandan_org.png","思考":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/30/2018new_sikao_org.png","疑问":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b8/2018new_ningwen_org.png","费解":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2a/2018new_wenhao_org.png","晕":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/07/2018new_yun_org.png","衰":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a2/2018new_shuai_org.png","骷髅":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a1/2018new_kulou_org.png","嘘":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b0/2018new_xu_org.png","闭嘴":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/2018new_bizui_org.png","傻眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/dd/2018new_shayan_org.png","裂开":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1b/202011_liekai_org.png","感冒":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8c/2022_cold_org.png","吃惊":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/2018new_chijing_org.png","吐":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/08/2018new_tu_org.png","生病":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3b/2018new_shengbing_org.png","拜拜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fd/2018new_baibai_org.png","鄙视":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/da/2018new_bishi_org.png","白眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ef/2018new_landelini_org.png","左哼哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/43/2018new_zuohengheng_org.png","右哼哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c1/2018new_youhengheng_org.png","抓狂":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/17/2018new_zhuakuang_org.png","怒骂":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/87/2018new_zhouma_org.png","打脸":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/cb/2018new_dalian_org.png","顶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/2018new_ding_org.png","互粉":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/86/2018new_hufen02_org.png","钱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a2/2018new_qian_org.png","哈欠":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/55/2018new_dahaqian_org.png","困":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/2018new_kun_org.png","睡":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e2/2018new_shuijiao_thumb.png","赢牛奶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9c/2021_yingniunai_org.png","开学季":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/72/2021_kaixueji_org.png","求饶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/moren_qiurao02_org.png","吃瓜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/01/2018new_chigua_org.png","打call":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/39/moren_dacall02_org.png",awsl:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/moren_awsl02_org.png","彩虹屁":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4b/2022_praise_org.png","酸":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b3/hot_wosuanle_org.png",doge:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a1/2018new_doge02_org.png","二哈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/22/2018new_erha_org.png","喵喵":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7b/2018new_miaomiao_org.png","单身狗":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/2021_alongdog_org.png","揣手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/2022_chuaishou_org.png","举手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fd/2022_raisehand_org.png","抱抱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/42/2018new_baobao_org.png","摊手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/2018new_tanshou_org.png","跪了":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/75/2018new_gui_org.png","握手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/2018new_woshou_org.png","赞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e6/2018new_zan_org.png",good:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8a/2018new_good_org.png","弱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3d/2018new_ruo_org.png","耶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/2018new_ye_org.png","拳头":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/86/2018new_quantou_org.png",ok:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/45/2018new_ok_org.png","加油":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/2018new_jiayou_org.png","作揖":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e7/2018new_zuoyi_org.png",haha:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1d/2018new_hahashoushi_org.png","鲜花":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/d4/2018new_xianhua_org.png","杰瑞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/da/2021_jerry_org.png","汤姆":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/31/2021_tom_org.png","tvgif-白眼":"https://i0.hdslb.com/bfs/emote/48f75163437445665a9be80bb316e4cb252c5415.gif","tvgif-doge":"https://i0.hdslb.com/bfs/emote/302d6c88c63ed162c81a49cafe7ed2709e6fb955.gif","tvgif-坏笑":"https://i0.hdslb.com/bfs/emote/5d2572efd09aab5dde9e2a198bb3f9ac1e2a982e.gif","tvgif-难过":"https://i0.hdslb.com/bfs/emote/9c6b41008a67755410f712334c64313df5f91b3f.gif","tvgif-生气":"https://i0.hdslb.com/bfs/emote/1902a5a2df5b5c931d88c12f0feb264b1e109d0d.gif","tvgif-委屈":"https://i0.hdslb.com/bfs/emote/af5a5853edb43a8178a8cb5df707fa5e88143699.gif","tvgif-斜眼笑":"https://i0.hdslb.com/bfs/emote/c66568b471192ca1f62f6ed4384dc1b283ab7508.gif","tvgif-呆":"https://i0.hdslb.com/bfs/emote/d3fa91e4db9215eb1e20ab9da44f1214aa4bda7b.gif","tvgif-发怒":"https://i0.hdslb.com/bfs/emote/3959eb81b952e4fa8d269d98f9e3639172d84073.gif","tvgif-惊吓":"https://i0.hdslb.com/bfs/emote/13549060757fcd92b11d0657d9b3b6038f97abb6.gif","tvgif-呕吐":"https://i0.hdslb.com/bfs/emote/db58e9442aae26694af18cc1683607cca3a16763.gif","tvgif-思考":"https://i0.hdslb.com/bfs/emote/b63f9146bfd985af014f8d6d4bdb498805be48f9.gif","tvgif-微笑":"https://i0.hdslb.com/bfs/emote/b98656855d782f61cb8edc7f7fca6563ecafff7e.gif","tvgif-疑问":"https://i0.hdslb.com/bfs/emote/fce1b1a0f3b0e39a2dc16a18508dba7b91e929f4.gif","tvgif-大哭":"https://i0.hdslb.com/bfs/emote/cba61f05f3039b02a7ffc0dfcd9d7995df9fdd74.gif","tvgif-鼓掌":"https://i0.hdslb.com/bfs/emote/be106e6b265883a9f28fbe10f7b765701e2618d4.gif","tvgif-抠鼻":"https://i0.hdslb.com/bfs/emote/696d9f93e722144dc2a78aeffc569418fdf3d565.gif","tvgif-亲亲":"https://i0.hdslb.com/bfs/emote/3534ea44ab74bd20352b88c245a06c4b4c46d271.gif","tvgif-调皮":"https://i0.hdslb.com/bfs/emote/fcd967395fd14e4dd5829fa7e8a967ce23205e52.gif","tvgif-笑哭":"https://i0.hdslb.com/bfs/emote/1c2fd1e8c9dde12812f86e5d4cbddd8993d98082.gif","tvgif-晕":"https://i0.hdslb.com/bfs/emote/030040ec5c9ddc9e3d067658c4139e7314ab42f8.gif","tvgif-点赞":"https://i0.hdslb.com/bfs/emote/30ecff401245fb56bcc1cf588d1809ac1ab1607c.gif","tvgif-害羞":"https://i0.hdslb.com/bfs/emote/411a3e459e8580f5bfd9f639a408247c4b509935.gif","tvgif-睡着":"https://i0.hdslb.com/bfs/emote/3c8b5e293261287a6203597e29b3de07df4d18c6.gif","tvgif-色":"https://i0.hdslb.com/bfs/emote/a0c6d99ab0ab63b8648f5283ff72cec04b604828.gif","tvgif-吐血":"https://i0.hdslb.com/bfs/emote/e17e4539e169d14a3389ff147afea760cebe5de5.gif","tvgif-无奈":"https://i0.hdslb.com/bfs/emote/eb4cb5f07cfd177c7e6a7914316717e56d9cc1d0.gif","tvgif-再见":"https://i0.hdslb.com/bfs/emote/344f61609ecce2008520dc8a977b6169215748a9.gif","tvgif-流汗":"https://i0.hdslb.com/bfs/emote/390bccec65eaff536bd5bb2a0c5b8b0bdea47334.gif","tvgif-偷笑":"https://i0.hdslb.com/bfs/emote/7f11e6f7f63e79112b833bd41fa13a83d7cd8474.gif","tvgif-抓狂":"https://i0.hdslb.com/bfs/emote/a476b93ecd8e94ac3257323fd822f91cef212de2.gif","tvgif-黑人问号":"https://i0.hdslb.com/bfs/emote/b609adf664be33224a9923262031165ae3e34cd2.gif","tvgif-困":"https://i0.hdslb.com/bfs/emote/91c2bf34ecf842d7016c01d841db3d4074bd281f.gif","tvgif-打脸":"https://i0.hdslb.com/bfs/emote/b0fad4856e59c1240e448437da3287bb5ce547e5.gif","tvgif-闭嘴":"https://i0.hdslb.com/bfs/emote/a3fc5388b09e945be3f18fe23bfed5874a0285b7.gif","tvgif-鄙视":"https://i0.hdslb.com/bfs/emote/293b5d459e6264ecf314d20937a936fa672ccd1e.gif","tvgif-腼腆":"https://i0.hdslb.com/bfs/emote/30984e8264324f901d19bea85dada7103b695534.gif","tvgif-馋":"https://i0.hdslb.com/bfs/emote/2525c5703c594e5f0752f68db8948773caebde47.gif","tvgif-可爱":"https://i0.hdslb.com/bfs/emote/f92d20f76258bc5f33fc9d7c5e2a1d41fef19a7c.gif","tvgif-发财":"https://i0.hdslb.com/bfs/emote/76131e52c9b033681b4c896c6024d29ef7ec7ec2.gif","tvgif-生病":"https://i0.hdslb.com/bfs/emote/beb94829fe04f1a41bd6ca611e1f6ca9ca169afa.gif","tvgif-流鼻血":"https://i0.hdslb.com/bfs/emote/8ef473f74a849420da712487b2f56ecca1f695f5.gif","tvgif-尴尬":"https://i0.hdslb.com/bfs/emote/e0b84ef5ee3e5b8978e584c7c5a6550c51d15f84.gif","tvgif-大佬":"https://i0.hdslb.com/bfs/emote/14ca0c05382b8741940942b2430b7a8d55c02f7e.gif","暹罗猫小豆泥-抱大腿":"https://i0.hdslb.com/bfs/emote/1e309b348e969e7ff1c7d873352799a2005494d5.png","暹罗猫小豆泥-不要":"https://i0.hdslb.com/bfs/emote/00d5e138feb370186c4e473061b21b42f8a3ea36.png","暹罗猫小豆泥-呆滞":"https://i0.hdslb.com/bfs/emote/b6ec6210f8c7095f4a14ccf8a6ec1b60fb1aa416.png","暹罗猫小豆泥-单纯":"https://i0.hdslb.com/bfs/emote/e5cdb0d44f35f545d37cbc95ca09cdb9f79ebf48.png","暹罗猫小豆泥-好耶":"https://i0.hdslb.com/bfs/emote/5fc0be80c750a057d1c068a9a3c65c7b09a49e02.png","暹罗猫小豆泥-惊讶":"https://i0.hdslb.com/bfs/emote/d6024fd52d7e66241062c045559974e2a4c6e87f.png","暹罗猫小豆泥-哭":"https://i0.hdslb.com/bfs/emote/9153d549e425cc02eb911695fff29cb59b338da0.png","暹罗猫小豆泥-来了":"https://i0.hdslb.com/bfs/emote/d5d12b9d885346de164f30d41a10f235872aaefa.png","暹罗猫小豆泥-呸":"https://i0.hdslb.com/bfs/emote/a7f7d5a13c8d1c1ff116e7362108fb49045b4b72.png","暹罗猫小豆泥-探头":"https://i0.hdslb.com/bfs/emote/4741a1d527c52365850368b2f480d5818b23cb8f.png","暹罗猫小豆泥-舔":"https://i0.hdslb.com/bfs/emote/d071edebf8d3fbad73d773e9049eee2a0c28f1d5.png","暹罗猫小豆泥-投币":"https://i0.hdslb.com/bfs/emote/77b10ddaf24b4547e712ba8ae8f8e51ca8c38bb1.png","暹罗猫小豆泥-苦鲁西":"https://i0.hdslb.com/bfs/emote/ad3b14a2a5cf6680468222581a9964577eaca3d3.png","暹罗猫小豆泥-再见":"https://i0.hdslb.com/bfs/emote/e4c72ecf403858750b881030d650769e79017561.png","暹罗猫小豆泥-震惊":"https://i0.hdslb.com/bfs/emote/7caf9631dfb93071a843e308e5382799494d3a71.png"},enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(e),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var e="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(e),Fluid.plugins.fancyBox(e)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><button id="floating-toc-button" class="floating-toc-button"><i class="iconfont icon-list"></i></button><div id="floating-toc" class="floating-toc"><div class="floating-toc-header"><i class="iconfont icon-list"></i></div><div class="floating-toc-body"><ul class="floating-toc-list" id="floating-toc-list"></ul></div></div><script>document.addEventListener("DOMContentLoaded",(function(){var t=document.getElementById("floating-toc-button"),e=document.getElementById("floating-toc"),n=document.getElementById("floating-toc-list"),o=!1,d=0,i=0;t.addEventListener("mousedown",(function(e){o=!0,d=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop})),document.addEventListener("mousemove",(function(e){o&&(t.style.left=e.clientX-d+"px",t.style.top=e.clientY-i+"px")})),document.addEventListener("mouseup",(function(){o=!1})),t.addEventListener("touchstart",(function(e){o=!0,d=e.touches[0].clientX-t.offsetLeft,i=e.touches[0].clientY-t.offsetTop})),document.addEventListener("touchmove",(function(e){o&&(t.style.left=e.touches[0].clientX-d+"px",t.style.top=e.touches[0].clientY-i+"px")})),document.addEventListener("touchend",(function(){o=!1})),t.addEventListener("click",(function(){e.classList.toggle("active")})),document.querySelectorAll(".markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6").forEach((function(t){var o=parseInt(t.tagName.charAt(1)),d=document.createElement("li"),i=document.createElement("a");i.classList.add("floating-toc-link"),i.textContent=t.textContent,i.setAttribute("href","#"+t.getAttribute("id")),d.classList.add("floating-toc-list-item"),d.classList.add("level-"+o),d.appendChild(i),n.appendChild(d),i.addEventListener("click",(function(n){n.preventDefault();var o=t.getAttribute("id"),d=document.getElementById(o),i=document.getElementsByClassName("header-inner")[0];if(d&&i){var c=window.pageYOffset,a=d.offsetTop+i.offsetHeight-c,s=null;window.requestAnimationFrame((function t(e){s||(s=e);var n,o=e-s,d=Math.min(o/1e3,1),i=(n=d)<.5?2*n*n:(4-2*n)*n-1;window.scrollTo(0,c+a*i),o<1e3&&window.requestAnimationFrame(t)}))}e.classList.remove("active")}))}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="leancloud-site-pv-container" style="display:none"><i class="iconfont iconPV"></i> <span id="leancloud-site-pv"></span> </span><span id="leancloud-site-uv-container" style="display:none"><i class="iconfont iconUV"></i> <span id="leancloud-site-uv"></span></span></div><div class="beian"><span><i class="iconfont iconICP-13"></i> <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">鄂 ICP 备 20000502 号</a></span></div><div class="footer-content"><a href="https://www.aimtao.net/categories/Mark/" rel="nofollow noopener"><span id="aimtao">© 2025 AimTao </span></a><i class="iconfont icon-love"></i> <span id="timeDate">loading...</span> <span id="times">loading...</span><script>var now=new Date;function createtime(){var n=new Date("11/28/2018 15:28:05");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="&nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script defer>if(!Fluid.ctx.dnt){var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?07fe5d228ae82eadee00480515f9d64b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script>!function(){var e=CONFIG.code_language.enable&&CONFIG.code_language.default,a=CONFIG.copy_btn;if(e||a){var i="";i+='<div class="code-widget">',i+="LANG",i+="</div>",jQuery(".markdown-body pre").each((function(){var n=jQuery(this);if(!(n.find("code.mermaid").length>0||n.find("span.line").length>0)){var t,c="";e&&(c=CONFIG.code_language.default,n[0].children.length>0&&n[0].children[0].classList.length>=2&&n.children().hasClass("hljs")?c=n[0].children[0].classList[1]:n[0].getAttribute("data-language")?c=n[0].getAttribute("data-language"):n.parent().hasClass("sourceCode")&&n[0].children.length>0&&n[0].children[0].classList.length>=2?(c=n[0].children[0].classList[1],n.parent().addClass("code-wrapper")):n.parent().hasClass("markdown-body")&&0===n[0].classList.length&&n.wrap('<div class="code-wrapper"></div>'),c=c.toUpperCase().replace("NONE",CONFIG.code_language.default)),n.append(i.replace("LANG",c).replace('code-widget">',(t=n[0],(Fluid.utils.getBackgroundLightness(t)>=0?"code-widget-light":"code-widget-dark")+(a?' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>':' code-widget">')))),a&&Fluid.utils.createScript("https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js",(function(){new window.ClipboardJS(".copy-btn",{target:function(e){for(var a=e.parentNode.childNodes,i=0;i<a.length;i++)if("CODE"===a[i].tagName)return a[i]}}).on("success",(function(e){e.clearSelection(),e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-copy","icon-success"),setTimeout((function(){e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-success","icon-copy")}),2e3)}))}))}}))}}()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="/js/leancloud.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>